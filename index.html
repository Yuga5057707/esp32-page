<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–î–ê–ß–ê 3-–§–∞–∑–Ω–∏–π –ú–æ–Ω—ñ—Ç–æ—Ä</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { background: #121212; color: #e0e0e0; font-family: Arial; margin:0; padding:20px; }
    h1 { text-align:center; margin-bottom:10px; }
    #status { font-weight:bold; text-align:center; margin-bottom:5px; }
    #lastUpdated { text-align:center; font-size:0.9em; color:#aaa; margin-bottom:20px; }
    #liveValues { display:flex; flex-wrap:wrap; justify-content:center; gap:20px; }
    .phase-box { background:#1e1e1e; border:1px solid #444; border-radius:10px; padding:15px; width:200px; }
    .minmax-box { background:#1c1c1c; border:1px dashed #555; border-radius:10px; padding:10px; margin:10px auto; width:90%; max-width:800px; font-size:0.85em; }
    canvas { background:#1e1e1e; border-radius:10px; padding:10px; display:block; width:100% !important; height:auto !important; max-height:280px; margin:20px auto; }
    #controls { text-align:center; margin:10px 0 20px; }
    .range-btn { background:#333; color:#fff; border:none; padding:8px 12px; margin:4px; border-radius:5px; cursor:pointer; }
    .range-btn:hover { background:#555; }
    footer { text-align:center; font-size:0.8em; color:#888; margin-top:40px; }
  </style>
</head>
<body>
  <h1>–î–ê–ß–ê 3-–§–∞–∑–Ω–∏–π –ú–æ–Ω—ñ—Ç–æ—Ä</h1>
  <div id="status">–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è...</div>
  <div id="lastUpdated">–û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: ‚Äî</div>

  <div id="liveValues">
    <div class="phase-box">
      <h3>–§–∞–∑–∞ A</h3>
      –°—Ç—Ä—É–º: <span id="currentA">...</span> A<br/>
      –ù–∞–ø—Ä—É–≥–∞: <span id="voltageA">...</span> V
    </div>
    <div class="phase-box">
      <h3>–§–∞–∑–∞ B</h3>
      –°—Ç—Ä—É–º: <span id="currentB">...</span> A<br/>
      –ù–∞–ø—Ä—É–≥–∞: <span id="voltageB">...</span> V
    </div>
    <div class="phase-box">
      <h3>–§–∞–∑–∞ C</h3>
      –°—Ç—Ä—É–º: <span id="currentC">...</span> A<br/>
      –ù–∞–ø—Ä—É–≥–∞: <span id="voltageC">...</span> V
    </div>
    <div class="phase-box">
      <h3>–ü–æ—Ç—É–∂–Ω—ñ—Å—Ç—å</h3>
      –°—É–º–∞—Ä–Ω–∞: <span id="power">...</span> –í—Ç
    </div>
  </div>

  <div class="minmax-box">
    üìä <b>–ü–æ—Ç–æ—á–Ω–∏–π –¥—ñ–∞–ø–∞–∑–æ–Ω:</b> <span id="dataCount">-</span> —Ç–æ—á–æ–∫<br/><br/>
    <b>–ó–∞ 1 –≥–æ–¥–∏–Ω—É:</b><br/>
      –°—Ç—Ä—É–º: –ú–∞–∫—Å <span id="iMax1h">-</span> / –ú—ñ–Ω <span id="iMin1h">-</span> / –°–µ—Ä–µ–¥–Ω—î <span id="iAvg1h">-</span> A<br/>
      –ù–∞–ø—Ä—É–≥–∞: –ú–∞–∫—Å <span id="vMax1h">-</span> / –ú—ñ–Ω <span id="vMin1h">-</span> / –°–µ—Ä–µ–¥–Ω—î <span id="vAvg1h">-</span> V<br/><br/>
    <b>–ó–∞ –¥–æ–±—É:</b><br/>
      –°—Ç—Ä—É–º: –ú–∞–∫—Å <span id="iMax24h">-</span> / –ú—ñ–Ω <span id="iMin24h">-</span> / –°–µ—Ä–µ–¥–Ω—î <span id="iAvg24h">-</span> A<br/>
      –ù–∞–ø—Ä—É–≥–∞: –ú–∞–∫—Å <span id="vMax24h">-</span> / –ú—ñ–Ω <span id="vMin24h">-</span> / –°–µ—Ä–µ–¥–Ω—î <span id="vAvg24h">-</span> V
  </div>

  <div id="controls">
    <button class="range-btn" onclick="setRange(1)">1 –≥–æ–¥–∏–Ω–∞</button>
    <button class="range-btn" onclick="setRange(2)">2 –≥–æ–¥–∏–Ω–∏</button>
    <button class="range-btn" onclick="setRange(6)">6 –≥–æ–¥–∏–Ω</button>
    <button class="range-btn" onclick="setRange(12)">12 –≥–æ–¥–∏–Ω</button>
    <button class="range-btn" onclick="setRange(24)">24 –≥–æ–¥–∏–Ω–∏</button>
    <button class="range-btn" onclick="reloadCharts()">–û–Ω–æ–≤–∏—Ç–∏ –≥—Ä–∞—Ñ—ñ–∫</button>
  </div>

  <canvas id="currentChart"></canvas>
  <canvas id="voltageChart"></canvas>

  <footer>
    ¬© <span id="curDate"></span> –†–æ–∑—Ä–æ–±–ª–µ–Ω–æ —Ç–∞ –≤–ø—Ä–æ–≤–∞–¥–∂–µ–Ω–æ –µ–ª–µ–∫—Ç—Ä–æ—Ç–µ—Ö–Ω—ñ—á–Ω–æ—é —Å–ª—É–∂–±–æ—é –ê3211
  </footer>

  <script>
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤—Å—Ç–∞–≤–∏–º–æ —Ä—ñ–∫
    document.getElementById("curDate").innerText = new Date().getFullYear();

    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDrXS4huWGNxljHaFF7zQ9oZTEein2N3xI",
      databaseURL: "https://esp32to3phase-default-rtdb.europe-west1.firebasedatabase.app"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // –ï–ª–µ–º–µ–Ω—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
    const statusEl = document.getElementById("status");
    const lastUpdatedEl = document.getElementById("lastUpdated");
    const currentEls = {
      currentA: document.getElementById("currentA"),
      voltageA: document.getElementById("voltageA"),
      currentB: document.getElementById("currentB"),
      voltageB: document.getElementById("voltageB"),
      currentC: document.getElementById("currentC"),
      voltageC: document.getElementById("voltageC"),
      power: document.getElementById("power")
    };
    const dataCountEl = document.getElementById("dataCount");
    const [iMax1h,iMin1h,iAvg1h,vMax1h,vMin1h,vAvg1h,
           iMax24h,iMin24h,iAvg24h,vMax24h,vMin24h,vAvg24h] =
      ["iMax1h","iMin1h","iAvg1h","vMax1h","vMin1h","vAvg1h",
       "iMax24h","iMin24h","iAvg24h","vMax24h","vMin24h","vAvg24h"]
      .map(id=>document.getElementById(id));

    // –ì—Ä–∞—Ñ—ñ–∫–∏
    const ctxI = document.getElementById("currentChart").getContext("2d");
    const ctxV = document.getElementById("voltageChart").getContext("2d");
    let chartI, chartV;
    let currentRange = parseInt(localStorage.getItem("rangeHours"))||1;

    // –§—É–Ω–∫—Ü—ñ—ó ---------------------------------------------------
    function setValuesDots(){
      Object.values(currentEls).forEach(el=>el.innerText="...");
      lastUpdatedEl.innerText="–û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: ‚Äî";
    }
/**
 * –ü—ñ–¥–ø–∏—Å—É—î–º–æ—Å—è –Ω–∞ –Ω–æ–≤—ñ –∑–∞–ø–∏—Å–∏ —É /history,
 * –±–µ—Ä–µ–º–æ —Ç—ñ–ª—å–∫–∏ –æ—Å—Ç–∞–Ω–Ω—ñ–π (limitToLast(1))
 * —ñ –æ–Ω–æ–≤–ª—é—î–º–æ –ø–æ—Ç–æ—á–Ω—ñ –ø–æ–∫–∞–∑–∏.
 */
function updateLiveData() {
  // –ü–æ—Ç—Ä—ñ–±–Ω–æ –ø—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è once –Ω–∞ limitToLast(1), –∞–ª–µ —â–æ–± –ø—Ä–∞—Ü—é–≤–∞–ª–æ live ‚Äî
  // –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—î–º–æ on('child_added') –Ω–∞ –∑–∞–ø–∏—Ç—ñ –∑ limitToLast(1).
  db.ref("/history")
    .orderByChild("ts")
    .limitToLast(1)
    .on("child_added", snap => {
      const d = snap.val();  // { ts, phaseA:{current,voltage}, phaseB:..., phaseC:... }
      // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –ø–æ–∫–∞–∑–∏
      currentEls.currentA .innerText = d.phaseA.current .toFixed(1);
      currentEls.voltageA .innerText = d.phaseA.voltage .toFixed(1);
      currentEls.currentB .innerText = d.phaseB.current .toFixed(1);
      currentEls.voltageB .innerText = d.phaseB.voltage .toFixed(1);
      currentEls.currentC .innerText = d.phaseC.current .toFixed(1);
      currentEls.voltageC .innerText = d.phaseC.voltage .toFixed(1);
      updatePower();

      // –û–Ω–æ–≤–ª—é—î–º–æ —á–∞—Å –Ω–∞–π–±–ª–∏–∂—á–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è
      lastUpdatedEl.innerText = "–û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: " 
        + new Date(d.ts * 1000).toLocaleString("uk-UA");
    });
}

    function updatePower(){
      const ia=parseFloat(currentEls.currentA.innerText)||0,
            ib=parseFloat(currentEls.currentB.innerText)||0,
            ic=parseFloat(currentEls.currentC.innerText)||0,
            va=parseFloat(currentEls.voltageA.innerText)||0,
            vb=parseFloat(currentEls.voltageB.innerText)||0,
            vc=parseFloat(currentEls.voltageC.innerText)||0;
      currentEls.power.innerText=(ia*va+ib*vb+ic*vc).toFixed(0);
    }
    function checkStatus(){
      statusEl.innerText="–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è...";statusEl.style.color="orange";setValuesDots();
      const now=Math.floor(Date.now()/1000);
      Promise.all([db.ref("/status/lastSeen").get(),db.ref("/status/online").get()])
      .then(([s,ol])=>{
        const ls=s.val(), on=ol.val();
        if(ls&&now-ls<=90||on===true){
          statusEl.innerText="–ü—ñ–¥–∫–ª—é—á–µ–Ω–æ"; statusEl.style.color="lime"; updateLiveData();
        } else {
          statusEl.innerText="ESP32 –æ—Ñ–ª–∞–π–Ω"; statusEl.style.color="red"; setValuesDots();
        }
      }).catch(e=>{
        statusEl.innerText="–ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è"; statusEl.style.color="red"; setValuesDots();
      });
    }
    function setRange(h){
      localStorage.setItem("rangeHours",h); currentRange=h; loadChartData(h);
    }
    function reloadCharts(){ loadChartData(currentRange); }
    function loadChartData(hours){
      const since= Math.floor(Date.now()/1000)-hours*3600;
      db.ref("/history").orderByChild("ts").startAt(since).once("value",snap=>{
        const data=[]; snap.forEach(c=>data.push(c.val()));
        if(!data.length) return;
        dataCountEl.innerText=data.length;
        // —á–∞—Å–æ–≤—ñ –º—ñ—Ç–∫–∏
        const labels=data.map(d=>new Date(d.ts*1000).toLocaleTimeString("uk-UA",{hour:"2-digit",minute:"2-digit"}));
        // –º–∞—Å–∏–≤–∏
        const iA=data.map(d=>d.phaseA.current),
              iB=data.map(d=>d.phaseB.current),
              iC=data.map(d=>d.phaseC.current),
              vA=data.map(d=>d.phaseA.voltage),
              vB=data.map(d=>d.phaseB.voltage),
              vC=data.map(d=>d.phaseC.voltage);
        // stats
        calcStats(data,3600,[iMax1h,iMin1h,iAvg1h],[vMax1h,vMin1h,vAvg1h]);
        calcStats(data,86400,[iMax24h,iMin24h,iAvg24h],[vMax24h,vMin24h,vAvg24h]);
        // –ø–æ–±—É–¥–æ–≤–∞ –≥—Ä–∞—Ñ—ñ–∫—ñ–≤
        if(chartI) chartI.destroy();
        chartI=new Chart(ctxI,{type:"line",data:{labels,datasets:[
          {label:"A (A)",data:iA,borderColor:"cyan",tension:0.3},
          {label:"B (A)",data:iB,borderColor:"orange",tension:0.3},
          {label:"C (A)",data:iC,borderColor:"lime",tension:0.3}
        ]},options:{responsive:true,scales:{x:{ticks:{color:"#999"}},y:{ticks:{color:"#999"}}},plugins:{legend:{labels:{color:"#ccc"}}}}});
        if(chartV) chartV.destroy();
        chartV=new Chart(ctxV,{type:"line",data:{labels,datasets:[
          {label:"A (V)",data:vA,borderColor:"#00bcd4",tension:0.3},
          {label:"B (V)",data:vB,borderColor:"#ff9800",tension:0.3},
          {label:"C (V)",data:vC,borderColor:"#8bc34a",tension:0.3}
        ]},options:{responsive:true,scales:{x:{ticks:{color:"#999"}},y:{ticks:{color:"#999"}}},plugins:{legend:{labels:{color:"#ccc"}}}}});
      });
    }
    function calcStats(raw,period,elemsI,elemsV){
      const now=Math.floor(Date.now()/1000),from=now-period;
      const arrI=raw.filter(d=>d.ts>=from).map(d=>d.phaseA.current).concat(raw.filter(d=>d.ts>=from).map(d=>d.phaseB.current),raw.filter(d=>d.ts>=from).map(d=>d.phaseC.current));
      const arrV=raw.filter(d=>d.ts>=from).map(d=>d.phaseA.voltage).concat(raw.filter(d=>d.ts>=from).map(d=>d.phaseB.voltage),raw.filter(d=>d.ts>=from).map(d=>d.phaseC.voltage));
      const stat=(arr)=>arr.length?{min:Math.min(...arr).toFixed(1),max:Math.max(...arr).toFixed(1),avg:(arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(1)}:{min:"-",max:"-",avg:"-"};
      const sI=stat(arrI), sV=stat(arrV);
      elemsI[0].innerText=sI.max; elemsI[1].innerText=sI.min; elemsI[2].innerText=sI.avg;
      elemsV[0].innerText=sV.max; elemsV[1].innerText=sV.min; elemsV[2].innerText=sV.avg;
    }

    // –°—Ç–∞—Ä—Ç
    checkStatus();
    reloadCharts();
    setInterval(reloadCharts,60000);
  </script>
</body>
</html>
