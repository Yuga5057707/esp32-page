<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ДАЧА 3-Фазний Монітор</title>

  <link rel="icon" type="image/png" href="favicon.png">
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { background: #121212; color: #e0e0e0; font-family: Arial; margin:0; padding:20px; }
    h1 { text-align:center; margin-bottom:10px; }
    #status { font-weight:bold; text-align:center; margin-bottom:5px; }
    #lastUpdated { text-align:center; font-size:0.9em; color:#aaa; margin-bottom:20px; }
    #liveValues { display:flex; flex-wrap:wrap; justify-content:center; gap:20px; }
    .phase-box { background:#1e1e1e; border:1px solid #444; border-radius:10px; padding:15px; width:200px; }
    .minmax-box { background:#1c1c1c; border:1px dashed #555; border-radius:10px; padding:10px; margin:10px auto; width:90%; max-width:800px; font-size:0.85em; }
    canvas { background:#1e1e1e; border-radius:10px; padding:10px; display:block; width:100% !important; height:auto !important; max-height:280px; margin:20px auto; }
    #controls { text-align:center; margin:10px 0 20px; }
    .range-btn { background:#333; color:#fff; border:none; padding:8px 12px; margin:4px; border-radius:5px; cursor:pointer; }
    .range-btn:hover { background:#555; }
    footer { text-align:center; font-size:0.8em; color:#888; margin-top:40px; }
  </style>
</head>
<body>
  <h1>ДАЧА 3-Фазний Монітор</h1>
  <div id="status">Перевірка підключення...</div>
  <div id="lastUpdated">Останнє оновлення: —</div>

  <div id="liveValues">
    <div class="phase-box">
      <h3>Фаза A</h3>
      Струм: <span id="currentA">...</span> A<br/>
      Напруга: <span id="voltageA">...</span> V
    </div>
    <div class="phase-box">
      <h3>Фаза B</h3>
      Струм: <span id="currentB">...</span> A<br/>
      Напруга: <span id="voltageB">...</span> V
    </div>
    <div class="phase-box">
      <h3>Фаза C</h3>
      Струм: <span id="currentC">...</span> A<br/>
      Напруга: <span id="voltageC">...</span> V
    </div>
    <div class="phase-box">
      <h3>Потужність</h3>
      Сумарна: <span id="power">...</span> Вт
    </div>
  </div>

  <div class="minmax-box">
    <b>Поточний діапазон:</b> <span id="dataCount">-</span> точок<br/><br/>
    <b>За 1 годину:</b><br/>
      Струм: Макс <span id="iMax1h">-</span> / Мін <span id="iMin1h">-</span> / Середнє <span id="iAvg1h">-</span> A<br/>
      Напруга: Макс <span id="vMax1h">-</span> / Мін <span id="vMin1h">-</span> / Середнє <span id="vAvg1h">-</span> V<br/><br/>
    <b>За добу:</b><br/>
      Струм: Макс <span id="iMax24h">-</span> / Мін <span id="iMin24h">-</span> / Середнє <span id="iAvg24h">-</span> A<br/>
      Напруга: Макс <span id="vMax24h">-</span> / Мін <span id="vMin24h">-</span> / Середнє <span id="vAvg24h">-</span> V
  </div>

  <div id="controls">
    <button class="range-btn" onclick="setRange(1)">1 година</button>
    <button class="range-btn" onclick="setRange(2)">2 години</button>
    <button class="range-btn" onclick="setRange(6)">6 годин</button>
    <button class="range-btn" onclick="setRange(12)">12 годин</button>
    <button class="range-btn" onclick="setRange(24)">24 години</button>
    <button class="range-btn" onclick="reloadCharts()">Оновити графік</button>
  </div>

  <canvas id="currentChart"></canvas>
  <canvas id="voltageChart"></canvas>

  <footer>
    © <span id="curDate"></span> Розроблено та впроваджено електротехнічною службою А3211
     За підтримкою звертатися ДИДИРКО Юрій 095 700 28 46
  </footer>

  <script>
    // Автоматично вставимо рік
    document.getElementById("curDate").innerText = new Date().getFullYear();

    // Ініціалізація Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDrXS4huWGNxljHaFF7zQ9oZTEein2N3xI",
      databaseURL: "https://esp32to3phase-default-rtdb.europe-west1.firebasedatabase.app"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Елементи сторінки
    const statusEl = document.getElementById("status");
    const lastUpdatedEl = document.getElementById("lastUpdated");
    const currentEls = {
      currentA: document.getElementById("currentA"),
      voltageA: document.getElementById("voltageA"),
      currentB: document.getElementById("currentB"),
      voltageB: document.getElementById("voltageB"),
      currentC: document.getElementById("currentC"),
      voltageC: document.getElementById("voltageC"),
      power: document.getElementById("power")
    };
    const dataCountEl = document.getElementById("dataCount");
    const [iMax1h,iMin1h,iAvg1h,vMax1h,vMin1h,vAvg1h,
           iMax24h,iMin24h,iAvg24h,vMax24h,vMin24h,vAvg24h] =
      ["iMax1h","iMin1h","iAvg1h","vMax1h","vMin1h","vAvg1h",
       "iMax24h","iMin24h","iAvg24h","vMax24h","vMin24h","vAvg24h"]
      .map(id=>document.getElementById(id));

    // Графіки
    const ctxI = document.getElementById("currentChart").getContext("2d");
    const ctxV = document.getElementById("voltageChart").getContext("2d");
    let chartI, chartV;
    let currentRange = parseInt(localStorage.getItem("rangeHours"))||1;

    // Функції ---------------------------------------------------
    function setValuesDots(){
      Object.values(currentEls).forEach(el=>el.innerText="...");
      lastUpdatedEl.innerText="Останнє оновлення: —";
    }
/**
 * Підписуємося на нові записи у /history,
 * беремо тільки останній (limitToLast(1))
 * і оновлюємо поточні покази.
 */
function updateLiveData() {
  // Потрібно підписатися once на limitToLast(1), але щоб працювало live —
  // використаємо on('child_added') на запиті з limitToLast(1).
  db.ref("/history")
    .orderByChild("ts")
    .limitToLast(1)
    .on("child_added", snap => {
      const d = snap.val();  // { ts, phaseA:{current,voltage}, phaseB:..., phaseC:... }
      // Встановлюємо покази
      currentEls.currentA .innerText = d.phaseA.current .toFixed(1);
      currentEls.voltageA .innerText = d.phaseA.voltage .toFixed(1);
      currentEls.currentB .innerText = d.phaseB.current .toFixed(1);
      currentEls.voltageB .innerText = d.phaseB.voltage .toFixed(1);
      currentEls.currentC .innerText = d.phaseC.current .toFixed(1);
      currentEls.voltageC .innerText = d.phaseC.voltage .toFixed(1);
      updatePower();

      // Оновлюємо час найближчого оновлення
      lastUpdatedEl.innerText = "Останнє оновлення: " 
        + new Date(d.ts * 1000).toLocaleString("uk-UA");
    });
}

    function updatePower(){
      const ia=parseFloat(currentEls.currentA.innerText)||0,
            ib=parseFloat(currentEls.currentB.innerText)||0,
            ic=parseFloat(currentEls.currentC.innerText)||0,
            va=parseFloat(currentEls.voltageA.innerText)||0,
            vb=parseFloat(currentEls.voltageB.innerText)||0,
            vc=parseFloat(currentEls.voltageC.innerText)||0;
      currentEls.power.innerText=(ia*va+ib*vb+ic*vc).toFixed(0);
    }
    function checkStatus(){
      statusEl.innerText="Перевірка підключення...";statusEl.style.color="orange";setValuesDots();
      const now=Math.floor(Date.now()/1000);
      Promise.all([db.ref("/status/lastSeen").get(),db.ref("/status/online").get()])
      .then(([s,ol])=>{
        const ls=s.val(), on=ol.val();
        if(ls&&now-ls<=90||on===true){
          statusEl.innerText="Підключено"; statusEl.style.color="lime"; updateLiveData();
        } else {
          statusEl.innerText="ESP32 офлайн"; statusEl.style.color="red"; setValuesDots();
        }
      }).catch(e=>{
        statusEl.innerText="Помилка з'єднання"; statusEl.style.color="red"; setValuesDots();
      });
    }
    function setRange(h){
      localStorage.setItem("rangeHours",h); currentRange=h; loadChartData(h);
    }
    function reloadCharts(){ loadChartData(currentRange); }
    /**
 * Завантажує і малює дані з /history за останні `hours` годин
 */
function loadChartData(hours) {
  const since = Math.floor(Date.now() / 1000) - hours * 3600;

  // Запитуємо всі записи з ts >= since
  db.ref("/history")
    .orderByChild("ts")
    .startAt(since)
    .once("value")
    .then(snap => {
      const records = [];
      snap.forEach(childSnap => {
        const rec = childSnap.val(); 
        // Для надійності перевіряємо, що структура правильна:
        if (rec.phaseA && rec.phaseB && rec.phaseC && rec.ts) {
          records.push(rec);
        }
      });

      // Якщо немає даних — чистимо графіки й виходимо
      if (records.length === 0) {
        dataCountEl.innerText = "0";
        if (chartI) chartI.destroy();
        if (chartV) chartV.destroy();
        return;
      }

      // Відобразити кількість точок
      dataCountEl.innerText = records.length;

      // Підписи по часу
      const labels = records.map(r =>
        new Date(r.ts * 1000).toLocaleTimeString("uk-UA", { hour: "2-digit", minute: "2-digit" })
      );

      // Збираємо окремі масиви струму і напруги
      const iA = records.map(r => r.phaseA.current);
      const iB = records.map(r => r.phaseB.current);
      const iC = records.map(r => r.phaseC.current);
      const vA = records.map(r => r.phaseA.voltage);
      const vB = records.map(r => r.phaseB.voltage);
      const vC = records.map(r => r.phaseC.voltage);

      // Оновлюємо статистику
      calcStats(records, 3600, [iMax1h, iMin1h, iAvg1h], [vMax1h, vMin1h, vAvg1h]);
      calcStats(records, 86400, [iMax24h, iMin24h, iAvg24h], [vMax24h, vMin24h, vAvg24h]);

      // Малюємо графік струмів
      if (chartI) chartI.destroy();
      chartI = new Chart(ctxI, {
        type: "line",
        data: {
          labels,
          datasets: [
            { label: "A (A)", data: iA, borderColor: "cyan", tension: 0.3 },
            { label: "B (A)", data: iB, borderColor: "orange", tension: 0.3 },
            { label: "C (A)", data: iC, borderColor: "lime", tension: 0.3 }
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { labels: { color: "#ccc" } } },
          scales: {
            x: { ticks: { color: "#999" } },
            y: { ticks: { color: "#999" } }
          }
        }
      });

      // Малюємо графік напруг
      if (chartV) chartV.destroy();
      chartV = new Chart(ctxV, {
        type: "line",
        data: {
          labels,
          datasets: [
            { label: "A (V)", data: vA, borderColor: "#00bcd4", tension: 0.3 },
            { label: "B (V)", data: vB, borderColor: "#ff9800", tension: 0.3 },
            { label: "C (V)", data: vC, borderColor: "#8bc34a", tension: 0.3 }
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { labels: { color: "#ccc" } } },
          scales: {
            x: { ticks: { color: "#999" } },
            y: { ticks: { color: "#999" } }
          }
        }
      });
    })
    .catch(err => {
      console.error("Помилка завантаження історії:", err);
    });
}

    function calcStats(raw,period,elemsI,elemsV){
      const now=Math.floor(Date.now()/1000),from=now-period;
      const arrI=raw.filter(d=>d.ts>=from).map(d=>d.phaseA.current).concat(raw.filter(d=>d.ts>=from).map(d=>d.phaseB.current),raw.filter(d=>d.ts>=from).map(d=>d.phaseC.current));
      const arrV=raw.filter(d=>d.ts>=from).map(d=>d.phaseA.voltage).concat(raw.filter(d=>d.ts>=from).map(d=>d.phaseB.voltage),raw.filter(d=>d.ts>=from).map(d=>d.phaseC.voltage));
      const stat=(arr)=>arr.length?{min:Math.min(...arr).toFixed(1),max:Math.max(...arr).toFixed(1),avg:(arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(1)}:{min:"-",max:"-",avg:"-"};
      const sI=stat(arrI), sV=stat(arrV);
      elemsI[0].innerText=sI.max; elemsI[1].innerText=sI.min; elemsI[2].innerText=sI.avg;
      elemsV[0].innerText=sV.max; elemsV[1].innerText=sV.min; elemsV[2].innerText=sV.avg;
    }

    // Старт
    checkStatus();
    //updateLiveData();
    reloadCharts();
    setInterval(reloadCharts,60000);
  </script>
</body>
</html>
